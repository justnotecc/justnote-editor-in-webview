<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>CKEditor 5</title>
  <script src="/js/ckeditor.js"></script>
  <link rel="stylesheet" href="/css/tailwind.css">
  <link rel="stylesheet" href="/css/ckeditor.css">
</head>
<body class="antialiased overflow-x-hidden">
  <div class="px-1.5 py-1.5">
    <input type="text" name="titleInput" id="titleInput" class="block w-full text-lg text-gray-800 font-normal px-1.5 py-1.5 placeholder-gray-500 border-0 focus:outline-none focus:ring-0" placeholder="Note Title" autocomplete="off" />
  </div>
  <textarea name="bodyInput" id="bodyInput" placeholder="Start writing..."></textarea>

  <script>
    const editorConfig = {
      removePlugins: ['Autoformat'],
      fontColor: {
        colors: [
          { color: 'rgb(31, 41, 55)', label: 'Black' },
          { color: 'rgb(107, 114, 128)', label: 'Gray' },
          { color: 'rgb(185, 28, 28)', label: 'Red' },
          { color: 'rgb(252, 211, 77)', label: 'Yellow' },
          { color: 'rgb(217, 119, 6)', label: 'Orange' },
          { color: 'rgb(120, 53, 15)', label: 'Brown' },
          { color: 'rgb(21, 128, 61)', label: 'Green' },
          { color: 'rgb(29, 78, 216)', label: 'Blue' },
          { color: 'rgb(91, 33, 182)', label: 'Purple' },
          { color: 'rgb(219, 39, 119)', label: 'Pink' },
          { color: 'rgb(229, 231, 235)', label: 'Light gray' },
          { color: 'rgb(255, 255, 255)', label: 'White', hasBorder: true },
        ],
        columns: 6,
        documentColors: 0,
      },
      fontBackgroundColor: {
        colors: [
          { color: 'rgb(31, 41, 55)', label: 'Black' },
          { color: 'rgb(107, 114, 128)', label: 'Gray' },
          { color: 'rgb(239, 68, 68)', label: 'Red' },
          { color: 'rgb(252, 211, 77)', label: 'Yellow' },
          { color: 'rgb(245, 158, 11)', label: 'Orange' },
          { color: 'rgb(180, 83, 9)', label: 'Brown' },
          { color: 'rgb(74, 222, 128)', label: 'Green' },
          { color: 'rgb(147, 197, 253)', label: 'Blue' },
          { color: 'rgb(196, 181, 253)', label: 'Purple' },
          { color: 'rgb(251, 207, 232)', label: 'Pink' },
          { color: 'rgb(229, 231, 235)', label: 'Light gray' },
          { color: 'rgb(255, 255, 255)', label: 'White', hasBorder: true },
        ],
        columns: 6,
        documentColors: 0,
      },
    };

    ClassicEditor.create(document.querySelector('#bodyInput'), editorConfig)
      .then(editor => {

        const panel = document.querySelector('.ck.ck-sticky-panel__content');

        editor.editing.view.document.on('click', () => {
          const domSelection = window.getSelection();
          console.log(`isCollapsed: ${domSelection.isCollapsed}`)
          if (domSelection && !domSelection.isCollapsed) {
            let marginBottom = 0;
            if (panel.style.marginBottom) {
              marginBottom = parseInt(panel.style.marginBottom.slice(0, -2), 10);
            }

            const anchorElement = domSelection.anchorNode.parentElement;
            const focusElement = domSelection.focusNode.parentElement;
            const anchorTop = anchorElement.getBoundingClientRect().top;
            const focusTop = focusElement.getBoundingClientRect().top;
            const top = Math.min(anchorTop, focusTop) - marginBottom;

            const topHeight = 52 + 40;
            const toolbarHeight = 100;

            console.log(`top: ${top}, height: ${topHeight + toolbarHeight}`);
            if (top < topHeight + toolbarHeight) {
              panel.style.marginBottom = (topHeight + toolbarHeight - top) + 'px';
              console.log(`set and return`);
              return;
            }
          }

          console.log(`reset to zero`);
          panel.style.marginBottom = 0;
        });

        editor.editing.view.document.on('selectionChangeDone', (_, { domSelection }) => {
          if (domSelection.isCollapsed) panel.style.marginBottom = 0;
        });

        editor.editing.view.document.on('change:isFocused', () => {
          if (!editor.editing.view.document.isFocused) panel.style.marginBottom = 0;
        });

        const onDropdownOpenChange = (i) => {
          console.log(i);
          const dropdown = editor.ui.view.toolbar.items.get(i);
          if (dropdown.isOpen) {
            console.log('open')
            return;
          }

          console.log('close')
        }

        const toolbarItems = editor.ui.view.toolbar.items;
        toolbarItems.get(3).on('change:isOpen', () => onDropdownOpenChange(3));
        toolbarItems.get(4).on('change:isOpen', () => onDropdownOpenChange(4));
        toolbarItems.get(5).on('change:isOpen', () => onDropdownOpenChange(5));

        if (window.ReactNativeWebView) {
          const onFocusChange = () => {
            setTimeout(() => {
              const isBodyFocused = editor.editing.view.document.isFocused;
              if (document.hasFocus() || isBodyFocused) {
                window.ReactNativeWebView.postMessage('focus:webView:true');
              }
            }, 1);
          };
          document.querySelector('#titleInput').addEventListener('focus', onFocusChange);
          editor.editing.view.document.on('change:isFocused', onFocusChange);

          const getData = () => {
            const SEP = '_jUSTnOTE-sEpArAtOr_';
            const title = document.querySelector('#titleInput').value;
            const body = editor.getData();
            window.ReactNativeWebView.postMessage('data:webView:' + title + SEP + body);
          };

          window.justnote = { getData };
          window.ReactNativeWebView.postMessage('editor:isReady:true');
        }

        window.editor = editor;
      })
      .catch( error => {
        console.error('There was a problem initializing the editor.', error);
      });
  </script>
</body>
</html>
